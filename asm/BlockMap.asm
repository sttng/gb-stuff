; ==========================================================================
; InitialiseFromLevel
; --------------------------------------------------------------------------
; Initialises the block map from the currently loaded level.
; --------------------------------------------------------------------------
; Destroyed: AF, BC, DE, HL.
; ==========================================================================
IntialiseFromLevel:
	ld a,[BlockMap]
	ld h, a
	ld a,[BlockMap+1]
	ld l,a
	ld de,Header
	ld bc,Header_Size
.ldir
	ld a,[hl+]
	ld [de],a
	inc de
	dec bc
	ld a,b
	or c
	jr nz,.ldir
	
	ld a,[BlockMap]
	ld h, a
	ld a,[BlockMap+1]
	ld l,a

	ld a,h
	ld [Grid],a
	ld a,l
	ld [Grid+1],a

	ret


GetBlockFromPoint:       ; ??? UNUSED ???

; --------------------------------------------------------------------------
; Offset X by the origin.
; --------------------------------------------------------------------------

	push de
	ld b,h
	ld c,l
	ld hl,Origin_X
	ld a,[hl+]
	ld d, a
	ld e,[hl]
	or a
	ld a,l
	sub e
	ld e,a
	ld a,h
	sbc d
	ld d,a
	pop hl

; --------------------------------------------------------------------------
; Divide by 1024 (each block is 1024 units wide).
; --------------------------------------------------------------------------

	sra d
	sra d

; --------------------------------------------------------------------------
; Is the column outside the block map?
; --------------------------------------------------------------------------

	ld a,[Width]
	ld e,a
	cp d
	ret c

; --------------------------------------------------------------------------
; Offset Y by the origin.
; --------------------------------------------------------------------------

	push hl
	ld hl,Origin_Y
	ld a,[hl+]
	ld b,a
	ld c,[hl]
	pop hl
	or a
	;sbc hl,bc
	ld a,l
	sub c
	ld l,a
	ld a,h
	sbc b
	ld h,a

; --------------------------------------------------------------------------
; Divide by 1024 (each block is 1024 units high).
; --------------------------------------------------------------------------

	sra h
	sra h

; --------------------------------------------------------------------------
; Is the row outside the block map?
; --------------------------------------------------------------------------

	ld a,[Height]
	cp h
	ret c
	
; --------------------------------------------------------------------------
; Calculate the index into the block map (row * width + column).
; --------------------------------------------------------------------------

	push de
	call Maths.Mul.U8U8
	pop de
	ld e,d
	ld d,0
	add hl,de

; --------------------------------------------------------------------------
; Each block map entry is 2 bytes long.
; --------------------------------------------------------------------------

	add hl,hl

; --------------------------------------------------------------------------
; Offset by the start of the block map.
; --------------------------------------------------------------------------

	push hl
	ld hl,Grid
	ld a,[hl+]
	ld d,a
	ld e,[hl]
	pop hl
	add hl,de

; --------------------------------------------------------------------------
; Read the pointer to the block map data.
; --------------------------------------------------------------------------

	ld e,[hl]
	inc hl
	ld d,[hl]

; --------------------------------------------------------------------------
; Clear the carry flag to denote success.
; --------------------------------------------------------------------------

	or a
	ret

	
;---------------------


; ==========================================================================
; ldir / Memcopy
; --------------------------------------------------------------------------
; Copies specified memory-location to another location. 'Fake' ldir from Z80
; --------------------------------------------------------------------------
; Parameters:
; HL: Source
; DE: Destination
; BC: Count / Size
; ==========================================================================
ldir:
	ld a,[hl+]
	ld [de],a
	inc de
	dec bc
	ld a,b
	or c
	jr nz,ldir
	ret
